<script>
// ELEMENTI
const sidebarNav = document.getElementById("sidebarNav");
const searchInput = document.getElementById("searchInput");
const fileContent = document.getElementById("fileContent");

let currentFileName = null;

// CREA EDITOR
const editorWrapper = document.createElement("div");
editorWrapper.id = "editorWrapper";
editorWrapper.style.marginBottom = "20px";

const fileEditor = document.createElement("textarea");
fileEditor.id = "fileEditor";
fileEditor.style.width = "100%";
fileEditor.style.height = "260px";
fileEditor.style.padding = "10px";
fileEditor.style.background = "#1a1a1a";
fileEditor.style.color = "#fff";
fileEditor.style.border = "1px solid #404040";
fileEditor.style.borderRadius = "6px";
fileEditor.style.fontFamily = "monospace";
fileEditor.style.fontSize = "14px";

const saveBtn = document.createElement("button");
saveBtn.textContent = "ðŸ’¾ Salva file";
saveBtn.style.marginTop = "10px";
saveBtn.style.padding = "8px 12px";
saveBtn.style.background = "#008000";
saveBtn.style.color = "#fff";
saveBtn.style.border = "1px solid #404040";
saveBtn.style.borderRadius = "6px";
saveBtn.style.cursor = "pointer";

editorWrapper.appendChild(fileEditor);
editorWrapper.appendChild(saveBtn);
fileContent.appendChild(editorWrapper);

// PREVIEW
const preview = document.createElement("div");
preview.id = "filePreview";
preview.style.marginTop = "20px";
preview.className = "content";
fileContent.appendChild(preview);

// CARICA LISTA FILE
fetch("files/pagine.json")
    .then(res => res.json())
    .then(files => populateSidebar(files))
    .catch(err => console.error("Errore JSON:", err));

function populateSidebar(files) {
    sidebarNav.innerHTML = "";

    files.forEach(file => {
        const item = document.createElement("div");
        item.className = "nav-item";
        item.textContent = file.name;

        item.addEventListener("click", () => {
            loadEditableFile(file.path);
            setActive(item);
        });

        sidebarNav.appendChild(item);
    });
}

// CARICA FILE DA MODIFICARE
function loadEditableFile(path) {
    currentFileName = path;

    fetch("files/" + path)
        .then(res => res.text())
        .then(text => {
            fileEditor.value = text;
            updatePreview();
        })
        .catch(err => {
            console.error(err);
            preview.innerHTML = "<h2>Errore caricamento file</h2>";
        });
}

// AGGIORNA LIVE Lâ€™ANTEPRIMA
fileEditor.addEventListener("input", updatePreview);

function updatePreview() {
    preview.innerHTML = parseCustomMarkup(fileEditor.value);
}

// PARSER MARKUP PERSONALIZZATO
function parseCustomMarkup(text) {
    const lines = text.split("\n");
    let html = "";

    lines.forEach(line => {
        line = line.trim();
        if (!line) return;

        if (line.startsWith("**")) {
            html += `<h2>${line.replace("**", "").trim()}</h2>`;
        } 
        else if (line.startsWith("*")) {
            html += `<h1>${line.replace("*", "").trim()}</h1>`;
        }
        else if (line.startsWith("Â§")) {
            html += `<pre><code>${line.replace("Â§", "").trim()}</code></pre>`;
        }
        else if (line === "---") {
            html += `<hr>`;
        }
        else {
            html += `<p>${line}</p>`;
        }
    });

    return html;
}

// SALVA FILE SU GITHUB (tramite server Node.js)
saveBtn.addEventListener("click", () => {
    if (!currentFileName) return alert("Nessun file aperto.");

    fetch("http://localhost:3000/save-file", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            path: currentFileName,
            content: fileEditor.value
        })
    })
    .then(res => res.json())
    .then(data => {
        alert("âœ” File salvato su GitHub!");
        console.log(data);
    })
    .catch(err => {
        console.error(err);
        alert("âŒ Errore durante il salvataggio.");
    });
});

// SET ACTIVE
function setActive(activeItem) {
    document.querySelectorAll(".nav-item").forEach(i => i.classList.remove("active"));
    activeItem.classList.add("active");
}

// SEARCH
searchInput.addEventListener("input", () => {
    const q = searchInput.value.toLowerCase();
    document.querySelectorAll(".nav-item").forEach(item => {
        item.style.display = item.textContent.toLowerCase().includes(q) ? "flex" : "none";
    });
});
</script>
